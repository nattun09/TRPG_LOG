<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>ココフォリアログ整形ツール</title>
  <style type="text/css">
    @import url('https://fonts.googleapis.com/css2?family=M+PLUS+1:wght@100..900&family=M+PLUS+Rounded+1c&display=swap');

    body {
      font-family: 'M PLUS Rounded 1c', sans-serif;
      background: #f4f4f4;
      padding: 20px;
      margin: 0;
    }

    #chat {
      max-width: 800px;
      margin: auto;
    }

    .message {
      display: flex;
      align-items: flex-start;
      margin: 10px 0;
    }

    .avatar-wrapper {
      width: 100px;
      height: 100px;
      margin-right: 10px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 4px solid transparent;
      box-sizing: border-box;
    }

    .avatar {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .bubble {
      padding: 16px 20px;
      border-radius: 20px;
      flex: 1;
      font-size: 1.05rem;
      line-height: 1.6;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      word-wrap: break-word;
      color: black;
      position: relative;
    }

    .bubble.tail::after {
      content: '';
      position: absolute;
      top: 20px;
      left: -22px;
      width: 0;
      height: 0;
      border: 10px solid transparent;
      border-right-color: var(--bubble-color);
      margin-left: 6px;
    }

    .name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    #fileInput, #generateHTML, #applySettings {
      margin: 20px 10px 20px 0;
      font-family: 'M PLUS Rounded 1c', sans-serif;
    }

    #styleControls {
      margin: 10px 0;
    }

    @media (max-width: 600px) {
      .message {
        flex-direction: row;
        align-items: flex-start;
      }
      .avatar-wrapper {
        width: 60px;
        height: 60px;
        margin-right: 10px;
      }
      .avatar {
        width: 60px;
        height: 60px;
      }
      .bubble {
        font-size: 0.95rem;
        padding: 12px 14px;
        line-height: 1.5;
        max-width: calc(100% - 70px);
      }
    }
  </style>
</head>
<body>
  <h1>ココフォリアログ整形ツール</h1>
  <input type="file" id="fileInput" accept=".html" name="fileInput">
  <div id="avatarSettings"></div>
  <div id="styleControls">
    背景色: <input type="color" id="bgColor" value="#f4f4f4" name="bgColor">
    フキダシ色: <input type="color" id="bubbleColor" value="#ffffff" name="bubbleColor">
    文字・フキダシ: <input type="color" id="textColor" value="#000000" name="textColor">
  </div>
  <button id="applySettings">反映</button>
  <button id="generateHTML">HTMLとして出力</button>
  <div id="chat"></div>

  <script type="text/javascript">
    const fileInput = document.getElementById('fileInput');
    const applySettings = document.getElementById('applySettings');
    const chat = document.getElementById('chat');
    const avatarSettings = document.getElementById('avatarSettings');
    const avatars = {};
    const characterColors = {};
    const tailFlags = {};
    let messages = [];

    function applyStyleSettings() {
      document.body.style.backgroundColor = document.getElementById('bgColor').value;

      document.querySelectorAll('.bubble').forEach(el => {
        const nameEl = el.querySelector('.name');
        if (!nameEl) return;
        const name = nameEl.textContent.trim();
        const colorToggle = document.querySelector(`input.color-toggle[data-name="${name}"]`);
        const customColorInput = document.querySelector(`.bubble-color-picker[data-name="${name}"] .bubble-color-input`);
        let bubbleColor = document.getElementById('bubbleColor').value;
        if (colorToggle && colorToggle.checked && customColorInput) {
          bubbleColor = customColorInput.value;
        }
        el.style.backgroundColor = bubbleColor;
        el.style.setProperty('--bubble-color', bubbleColor);
        const textColorInput = document.querySelector(`.text-color-picker[data-name="${name}"] .text-color-input`);
        let textColor = document.getElementById('textColor').value;
        if (colorToggle && colorToggle.checked && textColorInput) {
          textColor = textColorInput.value;
        }
        el.style.color = textColor;
      });
    }

    function renderChat() {
      chat.innerHTML = '';
      messages.forEach(p => {
        const spans = p.querySelectorAll('span');
        if (spans.length >= 3) {
          const name = spans[1].textContent.trim();
          const textHTML = spans[2].innerHTML;

          const msgDiv = document.createElement('div');
          msgDiv.className = 'message';

          const avatarWrapper = document.createElement('div');
          avatarWrapper.className = 'avatar-wrapper';
          avatarWrapper.style.borderColor = characterColors[name] || 'transparent';

          if (avatars[name]) {
            const avatar = document.createElement('img');
            avatar.className = 'avatar';
            avatar.src = avatars[name];
            avatarWrapper.appendChild(avatar);
          }

          const bubble = document.createElement('div');
          bubble.className = 'bubble';
          if (tailFlags[name]) bubble.classList.add('tail');
          const colorToggle = document.querySelector(`input.color-toggle[data-name="${name}"]`);
          const textColorInput = document.querySelector(`.text-color-picker[data-name="${name}"] .text-color-input`);
          const nameColor = (colorToggle && colorToggle.checked && textColorInput) ? textColorInput.value : characterColors[name] || '#000';
          bubble.innerHTML = `<div class=\"name\" style=\"color:${nameColor}\">${name}</div><div>${textHTML}</div>`;

          msgDiv.appendChild(avatarWrapper);
          msgDiv.appendChild(bubble);
          chat.appendChild(msgDiv);
        }
      });
    }

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      const text = await file.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      messages = Array.from(doc.querySelectorAll('p'));

      const characterSet = new Set();
      messages.forEach(p => {
        const spans = p.querySelectorAll('span');
        if (spans.length >= 3) {
          const name = spans[1].textContent.trim();
          characterSet.add(name);
        }
      });

      avatarSettings.innerHTML = '<h3>キャラごとのアイコンと色を設定</h3>';
      characterSet.forEach(name => {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <label>${name}:
            <input type="text" placeholder="画像ファイル名 (例: icon1.png)" data-name="${name}" class="avatar-path">
            <input type="color" value="#cccccc" data-name="${name}" class="color-input">
            フキダシ: <input type="checkbox" data-name="${name}" class="tail-toggle">
            色指定: <input type="checkbox" data-name="${name}" class="color-toggle">
            <span class="text-color-picker" data-name="${name}" style="display:none;">
              文字色: <input type="color" value="#000000" class="text-color-input">
            </span>
            <span class="bubble-color-picker" data-name="${name}" style="display:none;">
              フキダシ色: <input type="color" value="#ffffff" class="bubble-color-input">
            </span>
            <span class="bubble-color-picker" data-name="${name}" style="display:none;">
              <input type="color" value="#ffffff" class="bubble-color-input">
            </span>
          </label><br>
        `;
        avatarSettings.appendChild(wrapper);
        characterColors[name] = '#cccccc';
        tailFlags[name] = false;
      });
    });

    applySettings.addEventListener('click', () => {
      document.querySelectorAll('input.avatar-path').forEach(input => {
        const name = input.dataset.name;
        avatars[name] = input.value;
      });
      document.querySelectorAll('input.color-input').forEach(input => {
        const name = input.dataset.name;
        characterColors[name] = input.value;
      });
      document.querySelectorAll('input.color-toggle').forEach(input => {
        const name = input.dataset.name;
        const colorPicker = document.querySelector(`.bubble-color-picker[data-name="${name}"]`);
        const textColorPicker = document.querySelector(`.text-color-picker[data-name="${name}"]`);
        if (input.checked) {
          colorPicker.style.display = 'inline';
          textColorPicker.style.display = 'inline';
        } else {
          colorPicker.style.display = 'none';
          textColorPicker.style.display = 'none';
        }
      });
      document.querySelectorAll('input.tail-toggle').forEach(input => {
        const name = input.dataset.name;
        tailFlags[name] = input.checked;
      });
      renderChat();
      applyStyleSettings();
    });

    document.getElementById('generateHTML').addEventListener('click', () => {
      const cloneDoc = document.documentElement.cloneNode(true);
      const cloneBody = cloneDoc.querySelector('body');

      const elementsToRemove = cloneBody.querySelectorAll('#fileInput, #avatarSettings, #applySettings, #generateHTML, #styleControls, h1');
      elementsToRemove.forEach(el => el.remove());

      const scripts = cloneDoc.querySelectorAll('script');
      scripts.forEach(script => script.remove());

      cloneDoc.querySelector('body').style.backgroundColor = document.getElementById('bgColor').value;
      chat.querySelectorAll('.bubble').forEach((originalEl, index) => {
        const targetEl = cloneDoc.querySelectorAll('.bubble')[index];
        if (targetEl) {
          const computedColor = window.getComputedStyle(originalEl).getPropertyValue('background-color');
          const computedTextColor = window.getComputedStyle(originalEl).getPropertyValue('color');
          targetEl.style.backgroundColor = computedColor;
          targetEl.style.color = computedTextColor;
          targetEl.style.setProperty('--bubble-color', computedColor);
        }
      });

      const doctype = '<!DOCTYPE html>';
      const html = doctype + '\n' + cloneDoc.outerHTML;
      const blob = new Blob([html], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'chat_view.html';
      a.click();
    });
  </script>
</body>
</html>
